From 06bf724977d5f48c17f579556ce93822f3168b93 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Fri, 2 Feb 2018 11:29:24 +0000
Subject: [PATCH 1/3] Ensure apparmor_parser gives us error codes

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 src/lib/build.c | 3 ++-
 src/lib/load.c  | 1 +
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/lib/build.c b/src/lib/build.c
index a1d9dc4..3ad07bf 100644
--- a/src/lib/build.c
+++ b/src/lib/build.c
@@ -41,13 +41,14 @@ static bool aa_hook_context_build_one(AaHookContext *self, const char *source_di
         char *command[] = {
                 NULL,    /* parser_binary path */
                 "-WQTL", /* Write cache, never load, never read cache, set cache location */
+                "--abort-on-error",      /* We need error codes */
                 (char *)self->cache_dir, /* Target cache */
                 NULL,                    /* Path to file being parsed */
                 NULL,                    /* Terminator */
         };
 
         command[0] = (char *)self->parser_binary;
-        command[3] = path_buf;
+        command[4] = path_buf;
 
         if (aa_lsm_hook_exec_command(command) != 0) {
                 fprintf(stderr,
diff --git a/src/lib/load.c b/src/lib/load.c
index 3b14266..b699408 100644
--- a/src/lib/load.c
+++ b/src/lib/load.c
@@ -31,6 +31,7 @@ bool aa_hook_context_load_cache(AaHookContext *self)
         char *command[] = {
                 NULL,                    /* parser_binary path */
                 "-rB",                   /* Replace rules, read binary input */
+                "--abort-on-error",      /* We need error codes */
                 (char *)self->cache_dir, /* Target cache */
                 NULL,                    /* Terminator */
         };
-- 
2.16.1

